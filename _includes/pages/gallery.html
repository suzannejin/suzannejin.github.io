<div class="full-page" id="page-gallery">
    {% include nav.html %}
    <div class="page-content gallery-content">
        <div class="gallery-header">
            <h1>Gallery</h1>
            <p class="gallery-subtitle">A collection of moments</p>
        </div>

        <div class="photos-container" id="photosContainer">
            {% assign gallery_files = site.static_files | where_exp: "item", "item.path contains
            'assets/images/gallery/'" %}
            {% assign sorted_gallery = gallery_files | sort: 'name' | reverse %}

            {% for image in sorted_gallery %}
            {% if image.extname == '.png' or image.extname == '.jpg' or image.extname == '.jpeg' %}
            <div class="gallery-photo fade-in-hidden">
                <img src="{{ site.baseurl }}{{ image.path }}" alt="{{ image.name }}" loading="lazy">
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightboxModal" class="lightbox-modal">
        <span class="lightbox-close">&times;</span>
        <img class="lightbox-content" id="lightboxImage">
    </div>
</div>

<script>
    function initGallery() {
        const container = document.getElementById('photosContainer');
        const photos = document.querySelectorAll('.gallery-photo');
        const modal = document.getElementById('lightboxModal');
        const modalImg = document.getElementById('lightboxImage');
        const closeBtn = document.querySelector('.lightbox-close');

        if (!container || photos.length === 0) return;

        const containerWidth = container.offsetWidth;
        let maxY = 0;

        photos.forEach((photo, index) => {
            // Layout Logic
            const width = Math.floor(Math.random() * 200) + 200;
            photo.style.width = `${width}px`;

            const maxLeft = Math.max(0, containerWidth - width);
            const left = Math.floor(Math.random() * maxLeft);

            const verticalStep = 150;
            const randomOffset = Math.floor(Math.random() * 200) - 100;
            const top = (index * verticalStep) + randomOffset + 50;

            photo.style.left = `${left}px`;
            photo.style.top = `${top}px`;

            const bottom = top + (width * 0.75);
            if (bottom > maxY) maxY = bottom;

            photo.style.zIndex = Math.floor(Math.random() * 10);

            requestAnimationFrame(() => {
                photo.classList.remove('fade-in-hidden');
                photo.classList.add('fade-in-visible');
            });

            // Click to open lightbox
            photo.onclick = function () {
                modal.style.display = "flex";
                modalImg.src = this.querySelector('img').src;
            }
        });

        container.style.height = `${maxY + 300}px`;

        // Lightbox Close Logic
        if (closeBtn) {
            closeBtn.onclick = function () {
                modal.style.display = "none";
            }
        }

        if (modal) {
            modal.onclick = function (e) {
                if (e.target === modal) {
                    modal.style.display = "none";
                }
            }
        }
    }

    // Debounce function for resize
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Run on load
    document.addEventListener('DOMContentLoaded', initGallery);

    // Handle Resize
    window.addEventListener('resize', debounce(() => {
        // Only re-init if we are on the gallery page
        if (document.getElementById('page-gallery') && !document.getElementById('page-gallery').classList.contains('hidden')) {
            initGallery();
        }
    }, 250));

    window.initGallery = initGallery;
</script>